# 🌞 ソーラーサーキット開発 — Gemini CLI 作業依頼書 (WO‑xxx)

## 1. プロジェクト概要

ソーラーサーキット開発チームでは、作業報告書 `WO-xxx_report.md` を **Gemini CLI** で自動生成・更新できるようにする機能開発を進めています。本依頼書では、その実装タスク（A案）を Gemini CLI に対して正式に依頼します。

---

## 2. 目的（🚀 Purpose）

`WO-xxx_report.md` の **存在状態** と **内容** に応じて、以下の 4 種類の実行モードを自動的に切り替え、安全かつ柔軟にレポートを生成／更新できるようにします。

| 実行モード           | トリガ条件                        | 期待挙動                                           |
| --------------- | ---------------------------- | ---------------------------------------------- |
| 🆕 **新規生成**     | 対象ファイルが存在しない                 | テンプレートから新規生成し、上書きフラグを `NEW` としてログへ記録           |
| ✍️ **追記**       | ファイルが存在し、テンプレート範囲外にユーザー追記がある | 差分確認後、自動マージ候補を提示し追記部分を保持                       |
| 📝 **上書き**      | ファイルがテンプレートのまま（放置）           | テンプレートを再適用し上書き。フラグ `OVERWRITE_TEMPLATE` をログへ記録 |
| ⚠️ **回避 (不整合)** | ファイル内容が作業IDや日付などと矛盾          | 上書きを禁止し、`WO-xxx_report_recovered.md` に退避コピーを保存 |

---

## 3. 詳細要件

1. **テンプレート識別マーカー**

   * `<!-- TEMPLATE_START -->` と `<!-- TEMPLATE_END -->` を使用し、そのブロックが**完全一致**していれば「テンプレ放置」と判定すること。
2. **回避ファイルの命名規則**

   * `WO-xxx_report_recovered.md` とし、タイムスタンプを付与して衝突を避ける。例: `WO-123_report_recovered_20250709T1530.md`。
3. **強制上書きモード**

   * `.env` または CLI フラグ `--force` で有効化出来ること。強制時はモードに関係なくテンプレートを適用し `FORCED_OVERWRITE` をログへ記録。
4. **結果ログ出力**

   * 実行モード・対象ファイルパス・タイムスタンプをコンソールと `logs/report_generator.log` に出力。
5. **差分検出**

   * Python 標準の `difflib` もしくは GNU `diff` を用いた実装を想定。自動マージ不可の場合は手動解決用の差分パッチを `WO-xxx_report.patch` として保存。

---

## 4. 実装ガイドライン

* **言語 / ライブラリ**: Python 3.11 以上。追加パッケージは `requirements.txt` に明示。
* **ディレクトリ構成例**

  ```text
  tools/
    report_generator/
      __init__.py
      generator.py        # メインロジック
      utils.py            # テンプレ比較・差分検出など
      templates/
        WO_report_template.md
  logs/
  ```
* **ユニットテスト**: `pytest` で網羅率 80 % 以上。モックでファイル I/O をエミュレート。
* **CLI インタフェース**: `python -m tools.report_generator --work-id 123 [--force]` 形式。
* **コミットメッセージ規約**: Conventional Commits (`feat:`, `fix:`, `docs:` など)。

---

## 5. 受け入れ基準（✅ Done Definition）

* すべてのモードで正しいファイル操作とログ出力が行われる。
* `pytest` がグリーンである。
* 実行例（ハッピー・パス／各モード）が README に記載されている。
* レビューで指摘された重大バグ・要件漏れが解消されている。

---

## 6. 納期

* **提出期限**: 2025‑07‑15 (JST) 23:59

---

## 7. 参考情報

* プロジェクト環境: Windows 11 Home 24H2, Python 3.11 (WSL2 Ubuntu), GitHub Actions CI
* 主要 CLI コマンド一覧は `⭐Gemini CLI 主なコマンド.txt` を参照。

---

以上、よろしくお願いいたします。
