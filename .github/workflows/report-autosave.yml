name: autosave-report

# ────────────────────────────────────────────────
# solar-circuit-ci が Success になった後に自動実行
# ────────────────────────────────────────────────
on:
  workflow_run:
    workflows: ["solar-circuit-ci"]
    types:
      - completed

jobs:
  save-report:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 対象ブランチをチェックアウト
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      # 2️⃣ Python & 依存関係
      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: 📦 Install deps
        run: |
          pip install -r projects/solar_circuit/requirements-dev.txt

      # 3️⃣ changed-files で差分のある Work-Order ID を特定
      - name: 🔍 Detect changed Work-Order files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: projects/solar_circuit/workorders/incoming/**.json

      # 4️⃣ 変更された Work-Order ごとにレポートを生成・検証
      - name: 📝 Generate and Validate Reports
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            WO_ID=$(basename "$file" .json)
            echo "--- Processing $WO_ID ---"

            # ダミーレポートを生成
            DUMMY_REPORT_FILE="dummy_report.json"
            cat <<EOF > $DUMMY_REPORT_FILE
            {
              "schema": "gemini.report@1",
              "workorder_id": "$WO_ID",
              "round": 1,
              "phase": "coding",
              "status": "success",
              "summary": "This is a dummy report.",
              "timestamp": "2025-07-06T12:00:00Z"
            }
          EOF
            echo "Generated dummy report for $WO_ID"

            # レポートを検証
            sc report validate $DUMMY_REPORT_FILE
            echo "Validation successful for $WO_ID"

            # レポートを保存 (Markdown形式)
            DUMMY_MD_FILE="dummy_report.md"
            echo "# Dummy Report for $WO_ID" > $DUMMY_MD_FILE
            sc report save "$WO_ID" "$DUMMY_MD_FILE"
            echo "Saved dummy report for $WO_ID"
          done

      # 5️⃣ 生成レポートをコミット & プッシュ
      - name: 💾 Commit & push report
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add projects/solar_circuit/workorders/reports/*.md
          git commit -m "chore(report): autosave reports"
          git push
