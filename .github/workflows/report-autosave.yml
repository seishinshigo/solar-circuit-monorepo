name: autosave-report

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# solar-circuit-ci ãŒ Success ã«ãªã£ãŸå¾Œã«è‡ªå‹•å®Ÿè¡Œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  workflow_run:
    workflows: ["solar-circuit-ci"]
    types:
      - completed

jobs:
  save-report:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      # 2ï¸âƒ£ Python & ä¾å­˜é–¢ä¿‚
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ“¦ Install deps
        run: |
          pip install -r projects/solar_circuit/requirements-dev.txt

      # 3ï¸âƒ£ changed-files ã§å·®åˆ†ã®ã‚ã‚‹ Work-Order ID ã‚’ç‰¹å®š
      - name: ğŸ” Detect changed Work-Order files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: projects/solar_circuit/workorders/incoming/**.json

      # 4ï¸âƒ£ å¤‰æ›´ã•ã‚ŒãŸ Work-Order ã”ã¨ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆãƒ»æ¤œè¨¼
      - name: ğŸ“ Generate and Validate Reports
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            WO_ID=$(basename "$file" .json)
            echo "--- Processing $WO_ID ---"

            # ãƒ€ãƒŸãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
            DUMMY_REPORT_FILE="dummy_report.json"
            cat <<EOF > $DUMMY_REPORT_FILE
            {
              "schema": "gemini.report@1",
              "workorder_id": "$WO_ID",
              "round": 1,
              "phase": "coding",
              "status": "success",
              "summary": "This is a dummy report.",
              "timestamp": "2025-07-06T12:00:00Z"
            }
          EOF
            echo "Generated dummy report for $WO_ID"

            # ãƒ¬ãƒãƒ¼ãƒˆã‚’æ¤œè¨¼
            sc report validate $DUMMY_REPORT_FILE
            echo "Validation successful for $WO_ID"

            # ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜ (Markdownå½¢å¼)
            DUMMY_MD_FILE="dummy_report.md"
            echo "# Dummy Report for $WO_ID" > $DUMMY_MD_FILE
            sc report save "$WO_ID" "$DUMMY_MD_FILE"
            echo "Saved dummy report for $WO_ID"
          done

      # 5ï¸âƒ£ ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
      - name: ğŸ’¾ Commit & push report
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add projects/solar_circuit/workorders/reports/*.md
          git commit -m "chore(report): autosave reports"
          git push
