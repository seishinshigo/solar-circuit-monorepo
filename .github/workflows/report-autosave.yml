name: autosave-report

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# solar-circuit-ci ãŒ Success ã«ãªã£ãŸå¾Œã«è‡ªå‹•å®Ÿè¡Œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  workflow_run:
    workflows: ["solar-circuit-ci"]
    types:
      - completed

jobs:
  save-report:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      # 2ï¸âƒ£ Python & ä¾å­˜é–¢ä¿‚
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ“¦ Install deps
        run: |
          pip install -r projects/solar_circuit/requirements-dev.txt

      # 3ï¸âƒ£ ç›´è¿‘ã‚³ãƒŸãƒƒãƒˆå·®åˆ†ã‹ã‚‰ Work-Order ID ã‚’æŠ½å‡º
      - name: ğŸ” Detect Work-Order ID
        id: detect
        run: |
          WO_ID=$(git diff --name-only ${{ github.event.workflow_run.head_sha }}~1 \
                           ${{ github.event.workflow_run.head_sha }} \
                   | grep -oE 'wo-[0-9]{8}-[0-9]{3}' | head -n1) || true
          echo "WO_ID=$WO_ID" >> "$GITHUB_OUTPUT"

      # 4ï¸âƒ£ Work-Order å¤‰æ›´ãŒç„¡ã„å ´åˆã¯æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
      - name: â­ï¸ Skip if no WO_ID
        if: ${{ steps.detect.outputs.WO_ID == '' }}
        run: echo "No Work-Order diff found â€“ skipping autosave."

      # 5ï¸âƒ£ Gemini CLI ã§ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆãƒ€ãƒŸãƒ¼ä¾‹ï¼‰
      - name: ğŸ“ Generate report via Gemini
        if: ${{ steps.detect.outputs.WO_ID != '' }}
        run: |
          sc report save "${{ steps.detect.outputs.WO_ID }}"

      # 6ï¸âƒ£ ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
      - name: ğŸ’¾ Commit & push report
        if: ${{ steps.detect.outputs.WO_ID != '' }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add projects/solar_circuit/workorders/reports/${{ steps.detect.outputs.WO_ID }}_report.md
          git commit -m "chore(report): autosave ${{ steps.detect.outputs.WO_ID }}"
          git push
