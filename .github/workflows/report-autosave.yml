name: autosave-report

on:
  push:
    branches:            # ä»»æ„ï¼šé–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã®ã¿å¯¾è±¡
      - "feat/**"
      - "fix/**"
      - "chore/**"
  workflow_dispatch:     # æ‰‹å‹•ãƒˆãƒªã‚¬ã‚‚å¯

jobs:
  save-report:
    runs-on: ubuntu-latest

    steps:
    #-------------------------------------------------------------------
    - name: â˜‘ï¸  Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0          # diff å–å¾—ã®ãŸã‚ãƒ•ãƒ«å±¥æ­´

    - name: ðŸ  Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    # â€» Gemini CLI ãŒ pip ã§å…¥ã‚‹æƒ³å®šã€‚åˆ¥æ‰‹æ®µãªã‚‰æ›¸ãæ›ãˆ
    - name: ðŸ“¦  Install Gemini CLI
      run: pip install gemini-cli

    #-------------------------------------------------------------------
    - name: ðŸ” Detect Work-Order ID
      id: detect
      shell: bash
      run: |
        WO_ID=$(git diff --name-only ${{ github.sha }} ${{ github.sha }}^ \
                 | grep -Eo 'wo-[0-9]{8}-[0-9]{3}' | head -n1)
        echo "WO_ID=$WO_ID" >> $GITHUB_ENV
        echo "::notice title=WO_ID::$WO_ID"

    # WO_ID ãŒç„¡ã„ã‚³ãƒŸãƒƒãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦çµ‚äº†
    - name: âš ï¸  Skip if no WO_ID
      if: env.WO_ID == ''
      run: echo "No Work-Order ID detected â€” nothing to do."

    #-------------------------------------------------------------------
    - name: ðŸ“ Generate report via Gemini
      if: env.WO_ID != ''
      shell: bash
      run: |
        gemini /exec workorder "$WO_ID" --mode=report > "${WO_ID}_report.md"

    - name: ðŸ’¾ Save report & commit
      if: env.WO_ID != ''
      shell: bash
      run: |
        REPORT_DIR="projects/solar_circuit/workorders/reports"
        mkdir -p "$REPORT_DIR"
        mv "${WO_ID}_report.md" "$REPORT_DIR/${WO_ID}_report.md"

        git config user.name  "github-actions"
        git config user.email "actions@github.com"

        git add "$REPORT_DIR/${WO_ID}_report.md"
        git commit -m "docs: auto-generated report for ${WO_ID}" || echo "Nothing to commit"
        git push
