name: autosave-report

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â‘  main ã¸ã® push / â‘¡ PR ä¸Šã§ solar-circuit-ci æˆåŠŸå¾Œ
#    ã®ä¸¡æ–¹ã§ãƒ¬ãƒãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ & è‡ªå‹•ä¿å­˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_run:
    workflows: ["solar-circuit-ci"]
    types: [completed]

jobs:
  ensure-report:
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name != 'workflow_run')
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout HEAD
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.head_ref || github.ref_name }}

      # ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆGemini CLI ãªã©ï¼‰
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -r projects/solar_circuit/requirements-dev.txt

      # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º
      - name: ğŸ” Changed files
        id: changed
        uses: tj-actions/changed-files@v44
        with:
          files: |
            projects/solar_circuit/workorders/reports/*_report.md
            projects/solar_circuit/workorders/incoming/*.json

      # Work-Order ID ã‚’æ¨æ¸¬ï¼ˆreports ã«å·®åˆ†ãŒç„¡ã„å ´åˆã®ã¿ï¼‰
      - name: ğŸ§® Detect WO_ID
        id: detect
        if: steps.changed.outputs.any_changed == 'false'
        run: |
          WO=$(git diff --name-only HEAD~1 HEAD \
               | grep -oE 'wo-[0-9]{8}-[0-9]{3}' | head -n1) || true
          echo "WO_ID=$WO" >> $GITHUB_OUTPUT

      # report save ã‚’å®Ÿè¡Œ
      - name: ğŸ“ Generate & save report
        if: steps.detect.outputs.WO_ID != ''
        run: |
          sc report save "${{ steps.detect.outputs.WO_ID }}" README.md  # â† ãƒ€ãƒŸãƒ¼å…¥åŠ›
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add projects/solar_circuit/workorders/reports/${{ steps.detect.outputs.WO_ID }}_report.md
          git commit -m "chore(report): autosave ${{ steps.detect.outputs.WO_ID }}"
          git push
