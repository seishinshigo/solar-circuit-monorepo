name: autosave-report

# ────────────────────────────────────────────────
# solar-circuit-ci が Success になった後に自動実行
# ────────────────────────────────────────────────
on:
  workflow_run:
    workflows: ["solar-circuit-ci"]
    types:
      - completed

jobs:
  save-report:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 対象ブランチをチェックアウト
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      # 2️⃣ Python & 依存関係
      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: 📦 Install deps
        run: |
          pip install -r projects/solar_circuit/requirements-dev.txt

      # 3️⃣ 直近コミット差分から Work-Order ID を抽出
      - name: 🔍 Detect Work-Order ID
        id: detect
        run: |
          WO_ID=$(git diff --name-only ${{ github.event.workflow_run.head_sha }}~1 \
                           ${{ github.event.workflow_run.head_sha }} \
                   | grep -oE 'wo-[0-9]{8}-[0-9]{3}' | head -n1) || true
          echo "WO_ID=$WO_ID" >> "$GITHUB_OUTPUT"

      # 4️⃣ Work-Order 変更が無い場合は早期リターン
      - name: ⏭️ Skip if no WO_ID
        if: ${{ steps.detect.outputs.WO_ID == '' }}
        run: echo "No Work-Order diff found – skipping autosave."

      # 5️⃣ Gemini CLI でレポート生成（ダミー例）
      - name: 📝 Generate report via Gemini
        if: ${{ steps.detect.outputs.WO_ID != '' }}
        run: |
          sc report save "${{ steps.detect.outputs.WO_ID }}"

      # 6️⃣ 生成レポートをコミット & プッシュ
      - name: 💾 Commit & push report
        if: ${{ steps.detect.outputs.WO_ID != '' }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add projects/solar_circuit/workorders/reports/${{ steps.detect.outputs.WO_ID }}_report.md
          git commit -m "chore(report): autosave ${{ steps.detect.outputs.WO_ID }}"
          git push
